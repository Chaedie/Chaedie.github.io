---
title: K8S Client App í”„ë¡œì íŠ¸
date: 2025-03-06 # HH:MM:SS +/-TTTT
categories: [Devops]
tags: [aws, eks]     # TAG names should always be lowercase

description: Node.js, React, EKS, Jenkins, ArgoCD ë¥¼ í™œìš©í•œ K8S Client App í”„ë¡œì íŠ¸
toc: true
comments: true

---

# Devops Project

> <a href="https://devops2.front.chaedie.com" target="_blank">ì ‘ì† ë§í¬</a>



[ë°ëª¨ ì˜ìƒ]
![alt text](assets/img/devops2/demo.gif)



## í”„ë¡œì íŠ¸ ê°œìš”: K8S Client App  

[ìš”êµ¬ì‚¬í•­]

- SPA ì—ì„œ Kubectl get pods, k top nodes í‘œì¶œ
- Jenkins, ArgoCD í™œìš© CI/CD ìë™í™” êµ¬ì¶•
- AWS EKS Cluster êµ¬ì„±


## Project êµ¬ì„±

[CI/CD êµ¬ì„±ë„]
![alt text](assets/img/devops2/project.png)

[APP êµ¬ì„±ë„]
![alt text](/assets/img/devops2/front-proxy.png)

1. Terraform Provisioning
    - Jenkins Server (EC2 t2.medium)
    - Terraform Backend (S3, DynamoDB)
2. Jenkins
    - Github, Sonar Qube, Trivy, Docker, ECR
      ![alt text](/assets/img/devops2/jenkins-be.png)
      ![alt text](/assets/img/devops2/jenkins-fe.png)

3. ArgoCD
    - ArgoCD, EKS (K8S), Helm, 

4. Monitoring
    - Prometheus
    - Grafana

5. Application
    - Node.js (express), React.js, kubernetes/Client-node

## ğŸ“š Table of Contents

- [1. Jenkins Server ì„¸íŒ…](#1-jenkins-server-ì„¸íŒ…)  
   - [1.1. Jenkins Server Provisioning (with Terraform)](#11-jenkins-server-provisioning-with-terraform)  
   - [1.2. Jenkins Server CLI configure](#12-jenkins-server-cli-configure)  
   - [1.3. Jenkins Plugin ì„¤ì •](#13-jenkins-plugin-ì„¤ì •)  

- [2. SonarQube ì„¸íŒ…](#2-sonarqube-ì„¸íŒ…)  
   - [2.1. Create a Project](#21-create-a-project)  
   - [2.2. Create a Webhook](#22-create-a-webhook)  

- [3. ECR ì„¸íŒ…](#3-ecr-ì„¸íŒ…)  
   - [3.1. ECR ìƒì„±](#31-ecr-ìƒì„±)  

- [4. Jenkins Credentials ìƒì„±](#4-jenkins-credentials-ìƒì„±)  

- [5. Jenkins Tools ì„¤ì •](#5-jenkins-tools-ì„¤ì •)  

- [6. Jenkins System ì„¤ì •](#6-jenkins-system-ì„¤ì •)  

- [7. AWS EKS Cluster](#7-aws-eks-cluster)  
   - [7.1. EKS Cluster ìƒì„±](#71-eks-cluster-ìƒì„±)  
   - [7.2. Load Balancer ì„¤ì •](#72-load-balancer-ì„¤ì •)  

- [8. Prometheus, Grafana ì„¤ì¹˜](#8-prometheus-grafana-ì„¤ì¹˜)  
   - [8.1. ì„¤ì¹˜](#81-ì„¤ì¹˜)  
   - [8.2. Expose](#82-expose)  
   - [8.3. Prometheus, Grafana ì„¤ì •](#83-prometheus-grafana-ì„¤ì •)  

- [9. ArgoCD ì„¤ì •](#9-argocd-ì„¤ì •)  
   - [9.1. ArgoCD ì„¤ì¹˜](#91-argocd-ì„¤ì¹˜)  
   - [9.2. ArgoCD Repo ì„¤ì •](#92-argocd-repo-ì„¤ì •)  
   - [9.3. ArgoCD Application ì¶”ê°€](#93-argocd-application-ì¶”ê°€)  

- [10. CNAME Setting](#10-cname-setting)  

- [11. Ingress - TLS ì ìš©](#11-ingress---tls-ì ìš©)  

- [12. EKS Cluster & Jenkins Server ì‚­ì œ](#12-eks-cluster--jenkins-server-ì‚­ì œ)  

- [99. Trouble Shooting](#99-trouble-shooting)  
  - âŒ Dependency Check ë„ì¤‘ jenkins server ì‘ë‹µ ì—†ìŒ í˜„ìƒ
  - âŒ ArgoCD ì˜ ì¼ë¶€ pod ë“¤ì´ Pending ìƒíƒœì¸ ìƒí™©
  - âŒ Node App ì—ì„œ kubectl get pods ê¶Œí•œ ì´ìŠˆ
  - âŒ Frontend - 503 Service Temporarily Unavailable
  - âŒ ArgoCD - Sync ë¬´í•œ ë¡œë”©
  - âŒ FrontEnd Pod ë‚´ë¶€ì—ì„œ API Service ëª»ì°¾ëŠ” ì´ìŠˆ
  - âŒ K8s - FrontEnd Deploy ì´í›„ ì ê¹ì˜ 504 Gateway Timeout

## 1. Jenkins Server ì„¸íŒ…

### 1.1. Jenkins Server Provisioning (with Terraform)

- terraform ìœ¼ë¡œ ec2 ìƒì„±
- user data ë¡œ script ì‹¤í–‰

## 1.2. Jenkins Server CLI configure

```shell
aws configure 
```

### 1.3. Jenkins Plugin ì„¤ì •

- AWS Credentials
- Pipeline: AWS Steps
- Docker
- NodeJS
- SonarQube Scanner
- OWASP Dependency-Check
- Eclipse Temurin installer

## 2. SonarQube ì„¸íŒ…

### 2.1. Create a Project

- manual
- Locally
- Generate Token
  - Other Build
  - Linux

ìœ„ ê³¼ì •ì„ í†µí•´ frontend, backend ëª¨ë‘ ìƒì„±

### 2.2. Create a Webhook

## 3. ECR ì„¸íŒ…

### 3.1. ECR ìƒì„±

- frontend, backend ecr repository ìƒì„±

## 4. jenkins Credentials ìƒì„±

- AWS Credentials
- Github Credentials
- SonarQube Token
- ECR repo name


## 5. Jenkins Tools ì„¤ì •

- jdk installation
- SonarQube Scanner installation
- nodeJS
- Dependency-Check
- Docker

## 6. Jenkins System ì„¤ì •

- SonarQube IP ì„¤ì •

## 7. AWS EKS Cluster 

### 7.1. EKS Cluster ìƒì„±

```shell
eksctl create cluster \
  --name devops-project-2-k8s-eks-cluster \
  --region ap-northeast-2 \
  --node-type t2.medium \
  --nodes-min 2 \
  --nodes-max 2

```

### 7.2. Load Balancer ì„¤ì •

```shell
curl -O https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/refs/heads/main/docs/install/iam_policy.json

aws iam create-policy --policy-name AWSLoadBalancerControllerIAMPolicy --policy-document file://iam_policy.json

eksctl utils associate-iam-oidc-provider --region=ap-northeast-2 --cluster=devops-project-2-k8s-eks-cluster --approve

eksctl create iamserviceaccount --cluster=devops-project-2-k8s-eks-cluster --namespace=kube-system --name=aws-load-balancer-controller --role-name AmazonEKSLoadBalancerControllerRole --attach-policy-arn=arn:aws:iam::<your-account-id>:policy/AWSLoadBalancerControllerIAMPolicy --approve --region=ap-northeast-2

helm repo add eks https://aws.github.io/eks-charts
helm repo update eks
helm install aws-load-balancer-controller eks/aws-load-balancer-controller -n kube-system --set clusterName=devops-project-2-k8s-eks-cluster --set serviceAccount.create=false --set serviceAccount.name=aws-load-balancer-controller

kubectl get deployment -n kube-system aws-load-balancer-controller
```

## 8. Prometheus, Grafana ì„¤ì¹˜

### 8.1. ì„¤ì¹˜

```shell
helm repo add stable https://charts.helm.sh/stable
helm repo add prometheus-community https://prometheus-community.github.io/helm-charts

kubectl create ns monitoring
helm install stable prometheus-community/kube-prometheus-stack -n monitoring

kubectl get pods -n monitoring
kubectl get svc -n monitoring
```


### 8.2. Expose

```shell
kubectl edit svc stable-kube-prometheus-sta-prometheus -n monitoring
# ClusterIP -> LoadBalancer
kubectl get svc -n monitoring

kubectl edit svc stable-grafana -n monitoring
# ClusterIP -> LoadBalancer
kubectl get svc -n monitoring
```

### 8.3. Prometheus, Grafana ì„¤ì •

- ì´ˆê¸° ë¹„ë°€ë²ˆí˜¸: admin / prom-operator
- Add first add source - Prometheus
- Dashboard - New - Import - 6417 ([Kubernetes Cluster](https://grafana.com/grafana/dashboards/6417-kubernetes-cluster-prometheus/))


## 9. ArgoCD ì„¤ì •

### 9.1. ArgoCD ì„¤ì¹˜

```shell
kubectl create ns three-tier
kubectl create secret generic ecr-registry-secret \
  --from-file=.dockerconfigjson=${HOME}/.docker/config.json \
  --type=kubernetes.io/dockerconfigjson -n three-tier
```

```shell
kubectl create ns argocd
kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/v2.14.3/manifests/install.yaml

# Expose
kubectl patch svc argocd-server -n argocd -p '{"spec": {"type": "LoadBalancer"}}'

# Retrieve initial Admin password
kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d

```

### 9.2. ArgoCD Repo ì„¤ì •

- settings - connect repo

### 9.3. ArgoCD Application ì¶”ê°€

- Secret management ì¶”ê°€ í•„ìš” -> Vault ì‚¬ìš© ì˜ˆì •
- "+ new app" -> automatic sync

## 10. CNAME Setting

- route 53ì—ì„œ LoadBalancer ì— ëŒ€í•œ CNAME ì„¸íŒ…

## 11. Ingress - TLS ì ìš©

- AWS Certificate manager Service ì‚¬ìš©
- request a public certificate
- Domains - "Create records in Route 53" 
- ì¸ì¦ì´ ì™„ë£Œë˜ë©´ Certificate ARN ë³µì‚¬
  - `alb.ingress.kubernetes.io/certificate-arn: {ë³µì‚¬í•œ Certificate ARN}`
  - `alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS":443}]'`
  - `alb.ingress.kubernetes.io/ssl-redirect: "443"`

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: frontend-ingress
  namespace: three-tier
  annotations:
    alb.ingress.kubernetes.io/certificate-arn: {ë³µì‚¬í•œ Certificate ARN}
    alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS":443}]'
    alb.ingress.kubernetes.io/ssl-redirect: "443" 
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/target-type: ip
    alb.ingress.kubernetes.io/healthcheck-path: /health
spec:
  ingressClassName: alb
  rules:
    - host: devops2.front.chaedie.com
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: frontend
                port:
                  number: 80

```


## 12. EKS Cluster & Jenkins Server ì‚­ì œ

```shell
eksctl delete cluster --name devops-project-2-k8s-eks-cluster --region ap-northeast-2 --wait--timeout 30m

terraform destroy
```

---

## 99. Trouble Shooting

- EKS ë…¸ë“œ ê°¯ìˆ˜ë¥¼ ë³€ê²½í•˜ê³  ì‹¶ì„ ë•Œ
  - ```shell
      eksctl get nodegroup --cluster devops-project-2-k8s-eks-cluster

      eksctl scale nodegroup \
      --cluster devops-project-2-k8s-eks-cluster \
      --name ng-7d39f248 \
      --nodes 1 \
      --nodes-min 1 \
      --nodes-max 1
    ```

### âŒ Dependency Check ë„ì¤‘ jenkins server ì‘ë‹µ ì—†ìŒ í˜„ìƒ

- í˜„ìƒ: ec2 console ì—ì„œ status check ëŠ” 2/2 ë¡œ ì´ìƒì—†ì§€ë§Œ request ì—ëŠ” ì‘ë‹µí•˜ì§€ ì•ŠìŒ
- Monitoring Dashboard ë¥¼ ë³´ë©´ CPU Utilization, Storage Throughput ìŠ¤íŒŒí¬ í™•ì¸ 
- [AWS ê³µì‹ ìœ íŠœë¸Œ ì˜ìƒ - How do I troubleshoot an unresponsive website hosted on my EC2 instance?](https://www.youtube.com/watch?v=xvtoVxk8kWA)

![alt text](assets/img/devops2/image.png)
![alt text](assets/img/devops2/image-1.png)
![alt text](assets/img/devops2/image-2.png)

  - Health Check í™•ì¸
  - System Log í™•ì¸ for check the kernel panic
  - CPU Utilization í™•ì¸
  - Network in/out í™•ì¸
  - Storage í™•ì¸
  - Security Group í™•ì¸ (íœ´ë¨¼ì—ëŸ¬)
  - Networking - VPC - network ACL - inbound/outbound rule í™•ì¸
  - route table í™•ì¸
  - EIP í™•ì¸
  - SSH ë˜ëŠ” ê²½ìš°
    - ì„œë¹„ìŠ¤ í™•ì¸ `sudo systemctl status httpd`
    - firewall í™•ì¸ `sudo firewall-cmd --state`
    - ubuntu ì˜ ê²½ìš° `sudo ufw status verbose`
      - allow `sudo ufw allow in 80/tcp`, `sudo ufw allow 443/fcp`
    - /var/log/httpd ê²½ë¡œì˜ error_log, access_log í™•ì¸

httpd ì„œë¹„ìŠ¤ì—ì„œì˜ íŠ¸ëŸ¬ë¸” ìŠˆíŒ… ê³¼ì •ì„ ë³´ì—¬ì£¼ëŠ” ì˜ìƒì´ì—ˆëŠ”ë°, í•´ë‹¹ ì˜ìƒì„ ì‹œì²­í•˜ê³  ë‚˜ì„œ ec2ê°€ ì •ìƒìœ¼ë¡œ ëŒì•„ì™”ë‹¤. reboot ëª…ë ¹ ë•Œë¬¸ì¸ì§€ ë‹¨ì§€ ì‘ì—…ì´ ëì´ ë‚˜ì„œì¸ì§€ëŠ” ëª¨ë¥´ê³˜ì§€ë§Œ ìš°ì„  Trouble shooting ì‹œì˜ common step ì„ í•œë²ˆ í›‘ì–´ë³´ëŠ” ê¸°íšŒê°€ ë˜ì—ˆë‹¤. 
    
  
### âŒ ArgoCD ì˜ ì¼ë¶€ pod ë“¤ì´ Pending ìƒíƒœì¸ ìƒí™©

- ArgoCD ì˜ ì¼ë¶€ podë“¤ì´ pending ìƒíƒœë¡œ ë…¸ë“œì— ìŠ¤ì¼€ì¥´ë§ì´ ë˜ì§€ ì•ŠëŠ” í˜„ìƒ ë°œìƒ
- `kubectl top node` ë¥¼ í†µí•´ resource ë¥¼ í™•ì¸í•´ë³´ë‹ˆ memory 58% ê°€ëŸ‰ ì‚¬ìš©ì¤‘ì„ì„ í™•ì¸ 
- 1ê°œ ì˜€ë˜ node ë¥¼ 2ê°œë¡œ ëŠ˜ë ¤ì£¼ë‹ˆ í•´ê²°ì´ ë˜ì—ˆë‹¤.. ã…  
- resource limitsë¥¼ ê±¸ì–´ ì£¼ì–´ì•¼í•˜ë‚˜.. ã… 


![alt text](assets/img/devops2/image-3.png)

```shell
eksctl scale nodegroup \
      --cluster devops-project-2-k8s-eks-cluster \
      --name ng-7d39f248 \
      --nodes 2 \
      --nodes-min 2 \
      --nodes-max 2
```


- ë…¸ë“œë¥¼ 2ê°œë¡œ scale í•´ì£¼ì—ˆì§€ë§Œ pending state ì˜ pod ë“¤ì€ ìë™ìœ¼ë¡œ ë‹¤ë¥¸ ë…¸ë“œë¡œ ìŠ¤ì¼€ì¥´ë§ì´ ë˜ì§€ ì•ŠëŠ”ë‹¤.
- ì´ í˜„ìƒì€ drain, delete ë“±ìœ¼ë¡œ í•´ê²°í•´ì£¼ì–´ì•¼í•˜ëŠ”ë° ë‚˜ì˜ ê²½ìš°ëŠ” argoCD namespaceì˜ pods ë§Œ delete í•´ì£¼ì–´ ìƒˆë¡œ ë§Œë“  nodeë¡œ ìŠ¤ì¼€ì¥´ë§ ë˜ë„ë¡ í–ˆë‹¤.

---

### âŒ Node App ì—ì„œ kubectl get pods ê¶Œí•œ ì´ìŠˆ

- âŒ api server ì—ì„œ node client í™œìš©í•´ kubectl get pods í•´ì£¼ì—ˆì§€ë§Œ ê¶Œí•œë¬¸ì œë¡œ get pods ê°€ ë˜ì§€ ì•Šì•˜ë‹¤. ì´ë¥¼ í•´ê²° í•˜ê¸° ìœ„í•´ ServiceAccount ì— ëŒ€í•´ Role, RoleBinding ì„ ì§„í–‰í–ˆì§€ë§Œ ì—¬ì „íˆ ê¶Œí•œë¬¸ì œê°€ ë°œìƒí–ˆë‹¤. 
- ğŸ’¡ ì›ì¸ì€ `three-tier` namespace ì— ëŒ€í•œ ê¶Œí•œì„ ì¥ì–´ ì£¼ê³  `default` ns ì— ëŒ€í•œ get pods ë¥¼ ì§„í–‰í•´ì„œ ë¬¸ì œì˜€ë‹¤. 
- âœ… ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ namespace scope ì¸ role ì´ ì•„ë‹Œ cluster scope ì¸ ClusterRole ì„ ì§€ì •í•´ì£¼ì—ˆë‹¤. ë¶„ëª… CKA ì—ì„œ ë‚˜ì™€ì„œ ì•Œê³ ëŠ” ìˆëŠ” ë¶€ë¶„ì´ì§€ë§Œ ì§ì ‘ íŠ¸ëŸ¬ë¸” ìŠˆíŒ…ì„ í•˜ë©´ì„œ ê¹¨ë‹¬ìŒì„ ì–»ëŠ” í¬ì¸íŠ¸ì˜€ë‹¤.

```yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: pod-reader
  namespace: three-tier

---

apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: pod-reader
rules:
  - apiGroups: [""]
    resources: ["pods", "nodes", "namespaces"]
    verbs: ["get", "list", "watch"]

---

apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: pod-reader-binding
subjectsã…‹:
  - kind: ServiceAccount
    name: pod-reader
    namespace: three-tier
roleRef:
  kind: ClusterRole
  name: pod-reader
  apiGroup: rbac.authorization.k8s.io

```

### âŒ Frontend - 503 Service Temporarily Unavailable

- Frontend ë„ë©”ì¸ì— ì ‘ê·¼í–ˆì„ ë•Œ 503 page ê°€ ê³„ì† ë³´ì˜€ë‹¤. 503 ì´ë©´ ì„œë¹„ìŠ¤ ì—°ê²°ì´ ì œëŒ€ë¡œ ì•ˆëœê²ƒ ê°™ì€ë°, yaml ì„ ì•„ë¬´ë¦¬ ì‚´í´ë³´ì•„ë„ ë‹¤ë¥¸ì ì´ ì—†ì—ˆë”°. 
- `kubectl get endpoints -n three-tier` ë¥¼ í†µí•´ endpoint ë¥¼ í™•ì¸í•´ë³´ë‹ˆ forntend ì— ëŒ€í•œ endpoint ê°€ null ë¡œ ë– ìˆëŠ”ê±¸ í™•ì¸í–ˆê³ , label selet ì´ ì˜ëª»ë˜ì—ˆìŒì„ ì•Œê²Œ ë˜ì—ˆë‹¤.

### âŒ ArgoCD - Sync ë¬´í•œ ë¡œë”©

- ìœ„ ì´ìŠˆë¥¼ ê³ ì¹˜ëŠ” ê°€ìš´ë° label ì„ ë³€ê²½í—€ìŒì—ë„ ë¶ˆêµ¬í•˜ê³  endpoint ê°€ ìƒê¸°ì§€ ì•Šì•˜ë‹¤. 
- ArgoCD ì—ì„œ OutOfSync ìƒíƒœë„ ì œëŒ€ë¡œ ë³µêµ¬ê°€ ë˜ì§€ ì•Šì•˜ë‹¤. 
```
Failed sync attempt to 7d93e37ae03f6ca8efbb5f6a0ef42b26d2a6e830: one or more objects failed to apply, reason: error when replacing "/dev/shm/862046775": Deployment.apps "frontend" is invalid: spec.selector: Invalid value: v1.LabelSelector{MatchLabels:v1.LabelSelectorRequirement(nil)}: field is immutable
```
- ê²°êµ­ ìœ„ì™€ ê°™ì€ ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ í™•ì¸í–ˆê³ , deployment ì˜ label ì€ ì¤‘ë„ ë³€ê²½í•´ë„ ë°˜ì˜ë˜ì§€ ì•ŠëŠ”ë‹¤ëŠ” ì ì„ ì•Œê²Œ ë˜ì—ˆë‹¤.
- k8s ë¥¼ ì‚¬ìš©í• ë• ë‹¨ìˆœíˆ --force ì˜µì…˜ìœ¼ë¡œ ì§ì ‘ apply ë¥¼ í–ˆê¸°ì— ê°„ê³¼í–ˆë˜ ë¶€ë¶„ì¸ë° ArgoCD ë¥¼ ì‚¬ìš©í• ë•Œ Sync í• ë•ŒëŠ” force ì—†ì´ ì ìš©ì´ ì•ˆë˜ëŠ” ê²½ìš°ê°€ ìˆë‹¤ëŠ” ê±¸ ì²˜ìŒ ê²½í—˜í–ˆë‹¤.
- âœ… í•´ê²°ì˜ ê²½ìš° argoCD Sync ì—ì„œ --force ì˜µì…˜ì„ ì£¼ì–´ deployment ë¥¼ immutable í•˜ê²Œ ìƒˆë¡œ ìƒì„±í•´ì¤Œìœ¼ë¡œ í•´ê²°ë˜ì—ˆë‹¤.


### âŒ FrontEnd Pod ë‚´ë¶€ì—ì„œ API Service ëª»ì°¾ëŠ” ì´ìŠˆ

- api ì„œë¹„ìŠ¤ë¡œ API ì½œì„ í–ˆìœ¼ë‚˜ ì„œë¹„ìŠ¤ë¥¼ ì°¾ì§€ ëª»í•˜ëŠ” ì´ìŠˆ ë°œìƒ `http://api.three-tier.svc.cluster.local:3000/api/get/pods?namespace=default`
- `kubectl get svc -n three-tier` í•´ë³´ì•„ë„ íŠ¹ë³„í•œ ë¬¸ì œê°€ ì—†ëŠ” ìƒí™©
- ğŸ’¡ ê·¸ëŸ°ë°.. ìƒê°í•´ë³´ë©´ react ëŠ” nginx ì—ì„œ ì„œë¹™í•´ì¤¬ë‹¤ í•˜ë”ë¼ë„ ê²°êµ­ client ì¸ browser ì—ì„œ index.html ì´ ì‹¤í–‰ë˜ëŠ”ê±°ê³ , ê·¸ëŸ¼ browser ì—ì„œ `http://api.three-tier....:3000` ì´ë¼ëŠ” cluster ë‚´ë¶€ì˜ service host ì— API ë¥¼ ì°Œë¥´ê¸° ë•Œë¬¸ì— ë‹¹ì—°íˆ routing ì´ ì˜ëª»ëœê²ƒì´ë‹¤.

- âœ… ê·¸ëŸ¼ browser ì—ì„œ localhost (ìê¸° ìì‹ ) ì˜ url ë¡œ ì°Œë¥´ê²Œ í•˜ê³  nginx ê°€ `/api` url prefix ê°€ ë“¤ì–´ì˜¤ë©´ cluster ë‚´ë¶€ì˜ api service ë¥¼ ì°¾ë„ë¡ ë§Œë“¤ë©´ ë¬¸ì œ í•´ê²°

```
location /api/ {
  proxy_pass http://api.three-tier.svc.cluster.local:3000;
}
```

- ì´ ì´ì•¼ê¸°ëŠ” FrontEnd íŒŒíŠ¸ì¥ìœ¼ë¡œ ì¼í•˜ë©´ì„œ ê°œë°œíŒ€ì¥ë‹˜ê»˜ ì—¬ëŸ¬ë²ˆ ë°˜ë³µí•´ì„œ ì„¤ëª…ë“œë ¸ë˜ ì‚¬í•­ì¸ë° ì§ì ‘ Infra ë¥¼ ì„¸íŒ…í•˜ë‹¤ë³´ë‹ˆ client ì—ì„œ API ë¥¼ ì¹œë‹¤ëŠ” ì‚¬ì‹¤ì„ ì‚´ì§ ìŠê³  ìˆì—ˆë‹¤. ğŸ˜…
- ì•„ë˜ ì²˜ëŸ¼ ê·¸ë¦¬ë©´ ëŒ€ê°• ì´í•´ê°€ ë ê²ƒ ê°™ë‹¤.

![alt text](/assets/img/devops2/front-proxy.png)


### âŒ K8s - FrontEnd Deploy ì‹œ ì ê¹ì˜ 504 Gateway Timeout

- âŒ Jenkins Pipeline ì´ ëŒê³  ArgoCD ê°€ Deployment Sync ë¥¼ í•˜ì—¬ k8s ê°€ pods ë¥¼ rolling update ì‹œí‚¤ëŠ” ìƒí™©ì—ì„œ ì•„ì£¼ ì ê¹ 504 Gateway Timeout ì´ ë°œìƒí–ˆë‹¤. 
- Serviceì— ë³€ê²½ì ì´ ì—†ëŠ” ìƒí™©ì´ê³ , Rollout ì •ì±…ì´ RollinUpdate ë¡œ ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ì´ë¡ ì ìœ¼ë¡œ ë¬´ì¤‘ë‹¨ ë°°í¬ê°€ ë˜ì–´ì•¼ í•˜ëŠ”ë°, ì ê¹ì˜ íƒ€ì„ì•„ì›ƒì´ ë‚˜ëŠ” ì´ìœ ê°€ ë³„ë„ë¡œ ìˆì„ê²ƒì´ë‹¤.
- pods ê°€ NotReady ìƒíƒœì¸ ë™ì•ˆ traffic ì„ ë°›ì§€ ì•Šë„ë¡ í•˜ë ¤ë©´ ReadinessProbe ì„¸íŒ…ì„ í•´ì•¼í•˜ëŠ”ë° í˜„ì¬ í”„ë¡œì íŠ¸ì—ì„  ReadinessProbe ë¥¼ ì„¸íŒ…í•˜ì§€ ì•Šì•˜ë‹¤. 
- âœ… ReadinessProbe ë¥¼ ì„¸íŒ…í•´ì£¼ê³  initialDelaySeconds ë¥¼ ì¤Œìœ¼ë¡œì¨ ìµœì´ˆ 5ì´ˆê°„ì€ Not Ready ìƒíƒœë¡œ íŠ¸ë˜í”½ì„ ì£¼ì§€ ì•Šë„ë¡ ì„¸íŒ…í•´ì£¼ì—ˆë‹¤. 

```yaml
readinessProbe:
  httpGet:
    path: /
    port: 80
  initialDelaySeconds: 15
  periodSeconds: 10
```

- âŒ ReadinessProbe ë¥¼ ì¶”ê°€í•˜ë©´ íŠ¸ë˜í”½ì´ ì•ˆê°€ì„œ ë¬¸ì œ ì—†ì„ ì¤„ ì•Œì•˜ëŠ”ë°, ì•„ë˜ì™€ ê°™ì€ ë¬¸ì œê°€ ìƒê²¼ë‹¤.

```
upstream connect error or disconnect/reset before headers. retried and the latest reset reason: remote connection failure, transport failure reason: delayed connect error: Connection refused

```

- ingress ë¥¼ ì‚´í´ë³´ë‹ˆ `alb.ingress.kubernetes.io/healthcheck-path: /health` ì´ë ‡ê²Œ healthcheckë¥¼ í•˜ê³  ìˆì—ˆê³ , ì‚¬ì‹¤ frontend ì— í•´ë‹¹ ê²½ë¡œê°€ ì—†ìœ¼ë¯€ë¡œ / ë¡œ ë³€ê²½í•´ì£¼ì—ˆë‹¤.
  - ìœ„ ì¡°ì¹˜ë¥¼ ì·¨í–ˆìŒì—ë„ ê³„ì† ë¬¸ì œê°€ ìƒê²¨ ì°¾ì•„ë³´ë‹ˆ [Istio 503 UF ì´ìŠˆì™€ â€œBlame The Networkâ€](https://techblog.uplus.co.kr/istio-503-uf-%EC%9D%B4%EC%8A%88%EC%99%80-blame-the-network-24c37b5c80c2) ì´ëŸ° ê¸€ì´ ìˆë”ë¼. 

- ğŸ’¡ ìš°ì„  Istio ë¬¸ì œì„ì„ í™•ì¸í•˜ê¸° ìœ„í•´ istio ë¥¼ ì œê±°í•´ë³´ì•˜ë‹¤.
  - í•´ê²°ë˜ì§€ ì•ŠìŒ
- ğŸ’¡ deploy ì— minReadySeconds ë¥¼ ì§€ì •
- ë¹ˆë„ëŠ” ì¤„ì—ˆìœ¼ë‚˜ 502ê°€ ë°œìƒ, ë°œìƒ ì‹œì ì€ ìƒˆë¡œìš´ íŒŒë“œê°€ ìƒì„±ë  ë•Œê°€ ì•„ë‹Œ ê¸°ì¡´ íŒŒë“œê°€ ì •ë¦¬ë˜ëŠ” ì§§ì€ ìˆœê°„ì„ì„ í¬ì°©, íŒŒë“œ ì •ë¦¬ê°€ ê¹”ë”í•˜ê²Œ ë ìˆ˜ ìˆë„ë¡ terminationGracePeriodSeconds ì„ ì§€ì •í•´ì£¼ì—ˆë‹¤. (ArgoCD ë¥¼ í†µí•œ í¬ì°©, ë„ì›€ ë°›ì€ ë§í¬ [Kubernetes Podì˜ Graceful í•œ ì¢…ë£Œ](https://wlsdn3004.tistory.com/14))

![alt text](/assets/img/devops2/502.png)

- âŒ terminationGracePeriodSeconds ê¹Œì§€ 60ì´ˆë¡œ ì ìš©í–ˆëŠ”ë° 504 ê°€ ë°œìƒí–ˆë‹¤. 
  - ì´ì¯¤ë˜ë©´ deploy, pods ë§Œìœ¼ë¡œ assetì„ ë¬´ì¤‘ë‹¨ìœ¼ë¡œ serving í•˜ëŠ”ê²Œ ì§€ê¸ˆ êµ¬ì¡°ì—ì„  ë¶ˆê°€ëŠ¥í•œê±´ê°€? ë¼ëŠ” ìƒê°ì´ ë“ ë‹¤. pods ë¥¼ ë¬´ì‘ì • ëŠ˜ë¦°ë‹¤ë©´ í•´ê²°ì´ ë˜ëŠ”ê±¸ê¹Œ?
- ğŸ’¡ maxUnavailable: 0 ì„¤ì • ì‹¤í—˜
  - âŒ 0ìœ¼ë¡œ ì„¤ì •í•´ë„ ì• ì´ˆì— pod ë¬¸ì œê°€ ì•„ë‹ˆë¼ alb ë‚˜ ì„œë¹„ìŠ¤ì—ì„œ pod routing ì„ ì˜ëª»í•˜ëŠ”ê²ƒ ê°™ë‹¤.
  - [ê´€ë ¨ github issue](https://github.com/kubernetes-sigs/aws-load-balancer-controller/issues/1064)
  - [ê´€ë ¨ github issue 2](https://github.com/kubernetes-sigs/aws-load-balancer-controller/pull/955)
  - [ê´€ë ¨ ë‚´ìš©](https://whchoi98.gitbook.io/k8s/5.eks-ingress/alb-ingress)
- ğŸ’¡ ALB Ingress yaml ì— í—¬ìŠ¤ì²´í¬ ê´€ë ¨ ì–´ë…¸í…Œì´ì…˜ ìˆ˜ì •
  - âœ… ì²´ê°ìƒ ë‹¤ìš´íƒ€ì„ì´ ì¤„ì–´ ë“¤ì—ˆìŒ, ALB ì—ì„œì˜ í—¬ìŠ¤ì²´í¬ ì‹œê°„ì„ ì¤„ì—¬ì£¼ëŠ” ê²ƒì´ ê´€ê±´ìœ¼ë¡œ ë³´ì¸ë‹¤.
  
  ```yaml
    ## Health Check
    alb.ingress.kubernetes.io/healthcheck-path: /
    alb.ingress.kubernetes.io/healthcheck-protocol: HTTP
    # alb.ingress.kubernetes.io/healthcheck-port: traffic-port
    alb.ingress.kubernetes.io/healthcheck-interval-seconds: '10'
    alb.ingress.kubernetes.io/healthcheck-timeout-seconds: '5'
    alb.ingress.kubernetes.io/success-codes: '200'
    alb.ingress.kubernetes.io/healthy-threshold-count: '2'
    alb.ingress.kubernetes.io/unhealthy-threshold-count: '2' 
  ```


---

# ì¶”ê°€ êµ¬í˜„

## Rate Limiting 

- ë¶ˆí•„ìš”í•œ Work Loadë¥¼ ì¤„ì´ê¸° ìœ„í•´ Rate Limiting êµ¬í˜„ì´ í•„ìš”í•˜ë‹¤.
- 1\) FrontEnd - Throttling
- 2\) Istio Rate Limiting

### Rate Limiting (1) - FrontEnd Throttling

- âœ… Lodash ì˜ Throttle ì„ í™œìš©í•´ API ì½œì— 1ì´ˆ ì œí•œì„ ì£¼ì—ˆë‹¤.

### Rate Limiting (2) - Istio Rate Limiting - ğŸ› ï¸ ì‘ì—… ì¤‘

- ğŸ› ï¸ ì‘ì—… ì¤‘ - ë¯¸ì™„ì„±
- Istio ì„¤ì¹˜
  - ê³µì‹ë¬¸ì„œì—ëŠ” [istio-on-eks](https://github.com/aws-samples/istio-on-eks) ë¥¼ í†µí•´ ì„¤ì¹˜í•˜ë¼ê³  ë˜ì–´ ìˆì§€ë§Œ... blueprint ë¶€í„° ë„ˆë¬´ ë§ì€ ê²ƒì´ ë‹¤ë¥¸ ìƒí™©ì´ë¼ istioctl ì„ í†µí•´ ì§ì ‘ ì„¤ì¹˜í•´ë³¼ ì˜ˆì •ì´ë‹¤. ì˜ ë˜ì—ˆìœ¼ë©´ ì¢‹ê² ë‹¤. (ë‹¤ë¥¸ ìƒí™©ì´ë¼ê³  í‘œí˜„í–ˆì§€ë§Œ eks, ingress, istio ë“± ê¸°ìˆ  ì „ë°˜ì— ëŒ€í•œ ì´í•´ë„ê°€ ë¶€ì¡±í•œê²Œ ë” ì •í™•í•œ í‘œí˜„ì´ë‹¤.)
  - istioctl ì„¤ì¹˜
    ```shell
    curl -L https://istio.io/downloadIstio | sh -
    cd istio-1.25.0
    export PATH=$PWD/bin:$PATH

    istioctl install --set profile=default

    k get pods -n istio-system

    k label ns three-tier istio-injection=enabled --overwrite
    k rollout restart deployment -n three-tier
    k get pods -n three-tier --show-labels=true

    # uninstall
    istioctl uninstall -y --purge

    
    ```
  <!-- - istio ì„¤ì¹˜ ì‹œ nodePort ë¥¼ í†µí•´ ì ‘ê·¼í•˜ë ¤ë©´ Gateway ì™€ VirtualService ì„¤ì • í•„ìš” -->
- frontend-ingress ì¸ ALB ê°€ service ë¥¼ ë°”ë¡œ ë³´ê³  ìˆê¸° ë•Œë¬¸ì— istio ingress gateway ë¡œ ì—°ê²° í•  í•„ìš”ê°€ ìˆë‹¤. 
  - istio ingress gateway ì„¤ì •
    ```yaml
    apiVersion: networking.istio.io/v1beta1
    kind: Gateway
    metadata:
      name: frontend-gateway
      namespace: three-tier
    spec:
      selector:
        istio: ingressgateway
      servers:
        - port:
            number: 80
            name: http
            protocol: HTTP
          hosts:
            - "devops2.front.chaedie.com"
    ```
  - ALB ingress -> istio ingress gateway ì—°ê²°
    ```yaml
    apiVersion: networking.k8s.io/v1
    kind: Ingress
    metadata:
      name: frontend-ingress
      namespace: three-tier
      annotations:
        alb.ingress.kubernetes.io/target-type: ip
        # Istio
        alb.ingress.kubernetes.io/group.name: istio
    spec:
      rules:
        - host: devops2.front.chaedie.com
          http:
            paths:
              - path: /
                pathType: Prefix
                backend:
                  service:
                    # Istio
                    name: istio-ingressgateway
                    port:
                      number: 80
    ```
- Api Deployment ëŒ€ìƒìœ¼ë¡œ EnvoyFilter ìƒì„±

  ```yaml
  apiVersion: networking.istio.io/v1alpha3
  kind: EnvoyFilter
  metadata:
    name: rate-limit-my-app
    namespace: istio-system
  spec:
    workloadSelector:
      labels:
        app: api  # ì—¬ê¸°ì„œ íŠ¹ì • Deploymentë¥¼ íƒ€ê²ŸíŒ…
    configPatches:
      - applyTo: HTTP_FILTER
        match:
          context: SIDECAR_INBOUND # íŠ¹ì • ì‚¬ì´ë“œì¹´ì—ë§Œ ì ìš©
          listener:
            filterChain:
              filter:
                name: "envoy.filters.network.http_connection_manager"
        patch:
          operation: INSERT_BEFORE
          value:
            name: envoy.filters.http.local_ratelimit
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.local_ratelimit.v3.LocalRateLimit
              stat_prefix: http_local_rate_limiter
              token_bucket:
                max_tokens: 5          # ìµœëŒ€ í† í° ìˆ˜ (ì´ˆë‹¹ 5ê°œ ìš”ì²­ í—ˆìš©)
                tokens_per_fill: 5     # 1ì´ˆë§ˆë‹¤ í† í° 5ê°œ ì±„ì›€
                fill_interval: 1s      # ì±„ìš°ëŠ” ê°„ê²© (1ì´ˆ)
              filter_enabled:
                default_value:
                  numerator: 100
                  denominator: HUNDRED
              filter_enforced:
                default_value:
                  numerator: 100
                  denominator: HUNDRED
  ```
  - Test  `for i in {1..10}; do curl http://your-service; done`
  - âŒ ì—¬ê¸°ê¹Œì§€ ì§„í–‰í—€ë”ë‹ˆ ê°‘ìê¸° front í˜ì´ì§€ ì ‘ì†ì´ ì•ˆë˜ì—ˆë‹¤. 
    - ê¸‰í•˜ê²Œ istio ë¥¼ ì‚­ì œí•˜ê³ , ì ìš©í–ˆë˜ ëª¨ë“  istio ê´€ë ¨ ë¦¬ì†ŒìŠ¤ë¥¼ ì •ë¦¬í–ˆë‹¤. 
    - ë„¤íŠ¸ì›Œí¬ ì´ìŠˆë¡œ í”„ë¡ íŠ¸ í˜ì´ì§€ê°€ ì•ˆë– ì„œ ì´ê²ƒì €ê²ƒ ... ê¸‰í•˜ê²Œ... ì•Œì•„ë³´ë‹¤ ë³´ë‹ˆ route 53 ì— cname ìœ¼ë¡œ ë“±ë¡ëœ alb ì˜ ì£¼ì†Œì™€ ingress ì—ì„œì˜ alb ì˜ ì£¼ì†Œê°€ ë‹¤ë¥´ê²Œ ì ìš©ë˜ì–´ ìˆì—ˆë‹¤. 
    - ì•„ë§ˆ ALB Ingress yaml ì„ ë³€ê²½í•˜ê³  ì ìš©í•˜ëŠ” ê³¼ì •ì—ì„œ ip ì£¼ì†Œë¥¼ ìƒˆë¡œ í• ë‹¹ë°›ì•˜ë‚˜ ë³´ë‹¤ (AWS ìƒì—ì„œ resource ë¥¼ ìƒˆë¡œ ìƒì„±í•œê²ƒ ê°™ë‹¤.)
    - ğŸ’¡ í˜¼ì ë°°ìš´ê±¸ ì ìš©í•´ë³´ë©° ë§Œë“¤ì–´ê°€ëŠ” í† ì´ í”„ë¡œì íŠ¸ë¼ í•´ì„œ prod í™˜ê²½ë§Œ ê°€ì§€ê³  ì§„í–‰ì¤‘ì´ì—ˆëŠ”ë°, ì‹¤ì‹œê°„ìœ¼ë¡œ í•´ë‹¹ í˜ì´ì§€ë¥¼ ë“¤ì–´ê°€ë³´ëŠ” ì‚¬ëŒì´ ìˆì„í…ëŒ€ ë‹¤ìš´íƒ€ì„ì„ ë§Œë“ ê²ƒ ìì²´ê°€ í° ì‹¤ìˆ˜ë¼ê³  ìƒê°í•œë‹¤. dev / prod í™˜ê²½ìœ¼ë¡œ ë‚˜ëˆ ì•¼ê² ë‹¤. 
